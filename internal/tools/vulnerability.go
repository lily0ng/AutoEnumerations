package tools

import (
	"context"
	"fmt"
	"os/exec"
	"path/filepath"
)

func (r *Registry) registerVulnerabilityTools() {
	r.Register(&Tool{
		Name:        "nuclei",
		Category:    "vulnerability",
		Description: "Fast and customizable vulnerability scanner",
		InstallCmd:  "go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest",
		ExecuteFunc: executeNuclei,
	})

	r.Register(&Tool{
		Name:        "nikto",
		Category:    "vulnerability",
		Description: "Web server scanner",
		InstallCmd:  "apt-get install nikto || brew install nikto",
		ExecuteFunc: executeNikto,
	})
}

func executeNuclei(ctx context.Context, target, outputDir string) (interface{}, error) {
	outputFile := filepath.Join(outputDir, "nuclei.json")

	cmd := exec.CommandContext(ctx, "nuclei", "-u", target, "-o", outputFile, "-json", "-severity", "critical,high,medium")

	output, err := cmd.CombinedOutput()
	if err != nil {
		return nil, fmt.Errorf("nuclei failed: %w - %s", err, string(output))
	}

	return map[string]string{"output_file": outputFile}, nil
}

func executeNikto(ctx context.Context, target, outputDir string) (interface{}, error) {
	outputFile := filepath.Join(outputDir, "nikto.txt")

	cmd := exec.CommandContext(ctx, "nikto", "-h", target, "-o", outputFile)

	output, err := cmd.CombinedOutput()
	if err != nil {
		return nil, fmt.Errorf("nikto failed: %w - %s", err, string(output))
	}

	return map[string]string{"output_file": outputFile}, nil
}
